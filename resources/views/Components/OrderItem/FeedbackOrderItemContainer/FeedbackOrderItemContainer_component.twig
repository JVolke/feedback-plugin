<script type="text/javascript">
    (function($) {
        Vue.component('feedback-orderitem-container', {

            template: '#vue-feedback-orderitem-container',
            delimiters: ["${", "}"],
            props: ['items', 'itemImages', 'itemUrls', 'options', 'classes', 'styles'],

            data: function()
            {
                return {
                    authenticatedUser: {
                        id: 0,
                        isLoggedIn: false
                    },
                    feedback: {
                        ratingValue: 0
                    },
                    isLoading: true
                };
            },

            computed: {
                orderItems: function()
                {
                    // Filter out shipping costs (shipping costs is an order item)
                    var filtered = this.items.filter(function(value) {
                        if(value.itemVariationId > 0)
                        {
                            return value;
                        }
                    });

                    var aggregate = [];
                    for(var i = 0; i < filtered.length; i++) {
                        var value = filtered[i];
                        var image = this.itemImages[value.itemVariationId];
                        var url = this.itemUrls[value.itemVariationId];

                        aggregate.push({
                            name: value.orderItemName,
                            image: image,
                            url: url,
                            variationId: value.itemVariationId
                        });
                    }

                    return aggregate;
                }
            },

            mounted: function()
            {
                var _self = this;
                $.when(
                    this.getUser(),
                    this.prepare()
                ).done(function() {
                    _self.isLoading = false;
                    Vue.nextTick(function () {
                        // DOM updated
                        window.dispatchEvent(new Event('resize'));
                    })
                });
            },

            methods: {
                getUser: function()
                {
                    var _self = this;
                    return $.ajax({
                        type:           'GET',  // No data means this bad boy might get cached, think about workarounds
                        url:            '/rest/feedbacks/user',
                        success:        function(data)
                        {
                            _self.authenticatedUser = data;
                        },
                        error:          function(jqXHR, textStatus, errorThrown)
                        {
                            console.error(errorThrown);
                        }
                    });
                },
                prepare: function()
                {
                },
                onFeedbackAdded: function(event)
                {
                    // Event is expected to be the id, to which the feedback was added
                }
            }
        });
    })(jQuery);
</script>
